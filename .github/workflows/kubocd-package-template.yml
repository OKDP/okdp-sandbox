
#
# Copyright 2025 okdp.io
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

name: Build, test and push KuboCD packages

on:
  workflow_call:
    inputs:
      publish_to_registry:
        description: Wheter to push to the registry
        required: false
        type: string
        default: "false"
      registry:
        description: The container registry 
        required: true
        type: string
      ci_registry:
        description: "The registry used to push ci images"
        required: false
        type: string
        default: "ghcr.io"
      oci_package_prefix:
        description: "OCI package prefix, e.g., 'quay.io/my-org/<PACKAGE-PREFIX>', i.e.: <PACKAGE-PREFIX> = sandbox-packages"
        required: true
        type: string
      runs-on:
        description: GitHub Actions Runner image
        required: true
        type: string

defaults:
  run:
    shell: bash

jobs:
  
  kubocd-package:
    runs-on: ${{ inputs.runs-on }}
    steps:

      - name: Checkout Repo ‚ö°Ô∏è
        if: inputs.publish_to_registry == 'false'
        uses: actions/checkout@v4

      # - name: Free up disk space üì¶
      #   if: inputs.publish_to_registry == 'false'
      #   uses: okdp/gh-workflows/.github/actions/free-disk-space@v1

      - name: Login to the CI registry (${{ inputs.ci_registry }}) üîê
        if: inputs.publish_to_registry == 'false'
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.ci_registry }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login into public registry (${{ inputs.registry }}) üîê
        if: inputs.publish_to_registry == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_ROBOT_TOKEN }}

      - name: Set CI Github container registry namespace (${{ inputs.ci_registry }}) üì¶
        if: inputs.publish_to_registry == 'false'
        run:  |
          echo "OWNER=${GITHUB_REPOSITORY_OWNER@L}" >> $GITHUB_ENV
          echo "REGISTRY=${{ inputs.ci_registry }}" >> $GITHUB_ENV
        shell: bash

      - name: Set public container registry namespace (${{ inputs.registry }}) üì¶
        if: inputs.publish_to_registry == 'true'
        run:  |
          echo "OWNER=${GITHUB_REPOSITORY_OWNER@L}" >> $GITHUB_ENV
          echo "REGISTRY=${{ inputs.registry }}" >> $GITHUB_ENV
        shell: bash

      # Setup prerequisites
      - name: Set up Kind integration tests cluster üì¶
        if: inputs.publish_to_registry == 'false'
        uses: okdp/gh-workflows/.github/actions/setup-kind@v1

      - name: Setup helm üõ†Ô∏è
        if: inputs.publish_to_registry == 'false'
        uses: azure/setup-helm@v4.3.1
        with:
          version: v3.18.6
          
      - name: Setup Flux CLI üõ†Ô∏è
        if: inputs.publish_to_registry == 'false'
        uses: fluxcd/flux2/action@main
        with:
          version: '2.6.4'

      - name: Install yq üõ†Ô∏è
        if: inputs.publish_to_registry == 'false'
        run: |
          sudo wget -O /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Deploy Flux (Basic Mode) üöÄ
        if: inputs.publish_to_registry == 'false'
        run: flux install
      
      - name: Wait until FluxCD controllers are ready ‚åõ
        if: inputs.publish_to_registry == 'false'
        run: |
          kubectl wait --for=condition=ready pod -l app=source-controller -n flux-system --timeout=300s

      - name: Verify FluxCD controllers installation ‚úÖ
        if: inputs.publish_to_registry == 'false'
        run: |
          flux version
          kubectl -n flux-system get pods

      - name: Deploy KuboCD controllers on Kind üõ†Ô∏è
        if: inputs.publish_to_registry == 'false'
        run:
          kubectl apply -f clusters/sandbox/flux/kubocd.yaml

      - name: Install KuboCD CLI üõ†Ô∏è
        run: |
          # curl -L -o kubocd https://github.com/kubocd/kubocd/releases/download/v0.2.2/kubocd_Linux_x86_64
          # Temporary fix for: https://github.com/kubocd/kubocd/issues/2
          curl -L -o kubocd https://github.com/kubocd/kubocd/releases/download/v0.2.2/kubocd_fix2_Linux_x86_64

          # Make it executable
          chmod +x kubocd

          # Move to /usr/local/bin
          sudo mv kubocd /usr/local/bin/

          # Verify installation
          kubocd version

      # Build and push packages
      - name: Find KuboCD packages üîé
        run: |
          KUBOCD_PACKAGES=$(find packages -type f \( -name "*.yaml" -o -name "*.yml" \) -exec grep -l '^modules:' {} \; | tr '\n' ' ')
          echo "KUBOCD_PACKAGES=$KUBOCD_PACKAGES" >> $GITHUB_ENV

      - name: Build and push KuboCD packages into CI registry (${{ inputs.ci_registry }}) üì¶
        if: inputs.publish_to_registry == 'false'
        run: |
          for package in ${KUBOCD_PACKAGES}
          do
             echo "kubocd package ${package} --ociRepoPrefix $REGISTRY/$OWNER/${{ inputs.oci_package_prefix }}"
             kubocd package ${package} --ociRepoPrefix $REGISTRY/$OWNER/${{ inputs.oci_package_prefix }}
          done
        env:
          KCD_OCI_GHCR_IO_USER: ${{ github.actor }}
          KCD_OCI_GHCR_IO_SECRET: ${{ secrets.GITHUB_TOKEN }}

      - name: Create CI registry secret for KuboCD (kubocd-system namespace) üîê
        if: inputs.publish_to_registry == 'false'
        run: |
          kubectl create secret docker-registry ci-registry-secret \
            --docker-server=${{ inputs.ci_registry }} \
            --docker-username="${{ github.actor }}" \
            --docker-password="${{ secrets.GITHUB_TOKEN }}" \
            --docker-email="${{ github.actor }}@users.noreply.github.com" \
            -n kubocd-system

      # Deploy and test installation
      - name: Deploy and test releases on Kind cluster üöÄ
        if: inputs.publish_to_registry == 'false'
        run: |
          KUBOCD_CONTEXT=clusters/sandbox/default-context.yaml
          KUBOCD_RELEASES=$(find clusters/sandbox/releases -type d ! -exec find {} -type d -mindepth 1 \; | sort -u | tr '\n' ' ')

          echo "Apply context: $KUBOCD_CONTEXT"
          sed "s|${{ inputs.registry }}/$OWNER/${{ inputs.oci_package_prefix }}|${{ inputs.ci_registry }}/$OWNER/${{ inputs.oci_package_prefix }}|g" \
          "$KUBOCD_CONTEXT" | kubectl apply -f -

          # Find all KuboCD releases
          echo "Found KuboCD releases: $KUBOCD_RELEASES"

          for release in $KUBOCD_RELEASES; do
            echo "Applying releases in $release"
            find "$release" -type f \( -name "*.yaml" -o -name "*.yml" \) | while read rel; do
              # Update repository path and add secretRef
              yq eval "
                .spec.package.repository |= sub(\"${{ inputs.registry }}/$OWNER/${{ inputs.oci_package_prefix }}\",\"${{ inputs.ci_registry }}/$OWNER/${{ inputs.oci_package_prefix }}\") |
                .spec.package.secretRef = {\"name\": \"ci-registry-secret\"}
              " "$rel" | kubectl apply -f -
            done
          done

      - name: Test the releases deployment ‚úÖ
        if: inputs.publish_to_registry == 'false'
        run: |
          kubectl get events -A -w &
          (while true; do
            echo "Wait until all KuboCD releases are ready ..."
            echo "************************************** Releases status **************************************"
            kubectl get release -A
            echo "**************************************** Pods status ****************************************"
            kubectl get po -A
            sleep 15
          done) &
          kubectl wait --for=jsonpath='{.status.phase}'=READY release --all -A --timeout=600s
  
      - name: Build and push KuboCD packages into public registry (${{ inputs.registry }}) üì¶
        if: inputs.publish_to_registry == 'true'
        run: |
          for package in ${KUBOCD_PACKAGES}
          do
             echo "kubocd package ${package} --ociRepoPrefix $REGISTRY/$OWNER/${{ inputs.oci_package_prefix }}"
             kubocd package ${package} --ociRepoPrefix $REGISTRY/$OWNER/${{ inputs.oci_package_prefix }}
          done
        env:
          KCD_OCI_QUAY_IO_USER: ${{ secrets.REGISTRY_USERNAME }}
          KCD_OCI_QUAY_IO_SECRET: ${{ secrets.REGISTRY_ROBOT_TOKEN }}
