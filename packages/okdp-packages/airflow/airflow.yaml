apiVersion: v1alpha1
name: airflow
tag: 2.9.3-p03
protected: false
description: |
  Apache Airflow 2.9.3 - Workflow orchestration platform with Spark Operator integration

usage:
  text: |
    Apache Airflow release has been applied successfully.
    Pods, ingress, and certificate provisioning may still take a few minutes.

    Access the Airflow UI:
      URL: https://airflow-{{ .Release.spec.targetNamespace }}.{{ .Context.ingress.suffix }}
      Alternate URL: https://airflow.{{ .Context.ingress.suffix }}
      Default credentials: admin / admin

    Note:
      This sandbox uses a self-signed TLS issuer by default.
      If the browser shows NET::ERR_CERT_AUTHORITY_INVALID, use "Advanced" -> "Proceed"
      or trust the cluster certificate authority locally.

schema:
  parameters:
    properties: {}
  context:
    properties:
      certificateIssuers:
        required: true
        properties:
          selfSigned:
            properties:
              name: { type: string, required: true }
      ingress:
        required: true
        properties:
          suffix: { type: string, required: true }
      airflow:
        required: true
        properties:
          database:
            required: true
            properties:
              name: { type: string, required: true }
              host: { type: string, required: true }
              port: { type: integer, required: true }
              credentialsSecret:
                required: true
                properties:
                  name: { type: string, required: true }
                  usernameKey: { type: string, required: true }
                  passwordKey: { type: string, required: true }

modules:
  - name: main
    timeout: 15m
    source:
      helmRepository:
        url: https://airflow.apache.org
        chart: airflow
        version: 1.17.0
    values: |
      executor: LocalExecutor

      defaultAirflowTag: "2.9.3"
      airflowVersion: "2.9.3"

      webserver:
        defaultUser:
          enabled: true
          role: Admin
          username: admin
          email: admin@example.com
          firstName: admin
          lastName: user
          password: admin
        resources:
          requests:
            memory: "128Mi"
            cpu: "25m"
          limits:
            memory: "256Mi"
            cpu: "200m"

      scheduler:
        resources:
          requests:
            memory: "128Mi"
            cpu: "25m"
          limits:
            memory: "256Mi"
            cpu: "200m"

      triggerer:
        enabled: true
        resources:
          requests:
            memory: "64Mi"
            cpu: "25m"
          limits:
            memory: "128Mi"
            cpu: "100m"

      ingress:
        web:
          enabled: true
          ingressClassName: nginx
          annotations:
            kubernetes.io/ingress.class: nginx
            cert-manager.io/cluster-issuer: {{ .Context.certificateIssuers.selfSigned.name }}
            acme.cert-manager.io/http01-edit-in-place: "true"

          hosts:
            - name: airflow-{{ .Release.spec.targetNamespace }}.{{ .Context.ingress.suffix }}
              tls:
                enabled: true
                secretName: airflow-tls
            - name: airflow.{{ .Context.ingress.suffix }}
              tls:
                enabled: true
                secretName: airflow-tls

      # Use the shared CNPG PostgreSQL instance instead of the bundled bitnami subchart
      postgresql:
        enabled: false

      data:
        metadataConnection:
          user: airflow
          pass: airflow123
          protocol: postgresql
          host: {{ .Context.airflow.database.host }}
          port: {{ .Context.airflow.database.port }}
          db: {{ .Context.airflow.database.name }}
          sslmode: disable

      redis:
        enabled: false

      workers:
        replicas: 0

      dagProcessor:
        enabled: false

      dags:
        persistence:
          enabled: false
        gitSync:
          enabled: false

      flower:
        enabled: false
      pgbouncer:
        enabled: false
      statsd:
        enabled: false

      migrateDatabaseJob:
        enabled: true
        resources:
          requests:
            memory: "64Mi"
            cpu: "25m"
          limits:
            memory: "256Mi"
            cpu: "200m"

      createUserJob:
        resources:
          requests:
            memory: "64Mi"
            cpu: "25m"
          limits:
            memory: "256Mi"
            cpu: "200m"

      config:
        core:
          load_examples: 'False'

roles:
  - airflow

dependencies:
  - external-secrets
  - database-server
  - ingress
