#
# Copyright 2026 The OKDP Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# you may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#

{{- $root := . -}}
{{- $identities := list }}

{{- range .Values.sourceS3Secrets }}
  {{- $src := lookup "v1" "Secret" $.Release.Namespace .name }}
  {{- if not $src }}
    {{- fail (printf "Secret %s not found" .name) }}
  {{- end }}

  {{- /* Resolve accessKey (accessKey OR S3_ACCESS_KEY) */ -}}
  {{- $rawAccessKey := "" -}}
  {{- if and $src $src.data (hasKey $src.data "accessKey") -}}
    {{- $rawAccessKey = index $src.data "accessKey" -}}
  {{- else if and $src $src.data (hasKey $src.data "S3_ACCESS_KEY") }}
    {{- $rawAccessKey = index $src.data "S3_ACCESS_KEY" -}}
  {{- else -}}
    {{- fail "Required access key 'accessKey' or 'S3_ACCESS_KEY' not found in source secret" -}}
  {{- end -}}
  {{- $accessKey := required
        (printf "Secret %s is missing accessKey or S3_ACCESS_KEY" .name)
        $rawAccessKey
        | b64dec
  }}

  {{- /* Resolve secretKey (secretKey OR S3_SECRET_KEY OR S3_SECRET_ACCESS) */ -}}
  {{- $rawSecretKey := "" -}}
  {{- if and $src $src.data (hasKey $src.data "secretKey") -}}
    {{- $rawSecretKey = index $src.data "secretKey" -}}
  {{- else if and $src $src.data (hasKey $src.data "S3_SECRET_KEY") }}
    {{- $rawSecretKey = index $src.data "S3_SECRET_KEY" -}}
  {{- else if and $src $src.data (hasKey $src.data "S3_SECRET_ACCESS") }}
    {{- $rawSecretKey = index $src.data "S3_SECRET_ACCESS" -}}
  {{- else -}}
    {{- fail "Required secret key 'secretKey' or 'S3_ASECRET_KEY' or 'S3_SECRET_ACCESS' not found in source secret" -}}
  {{- end -}}
  {{- $secretKey := required
        (printf "Secret %s is missing secretKey or S3_SECRET_KEY or S3_SECRET_ACCESS" .name)
        $rawSecretKey
        | b64dec
  }}

  {{- $identities = append $identities (dict
        "name" .name
        "accessKey" $accessKey
        "secretKey" $secretKey
        "actions" .actions
    ) }}
{{- end }}

apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: {{ .Values.s3_secret }}
  labels:
    {{- include "ocp-oauth-htpasswd.labels" $root | nindent 4 }}
stringData:
  seaweedfs_s3_config: |
    {
      "identities": [
        {{- range $i, $id := $identities }}
        {{- if $i }},{{ end }}
        {
          "name": "{{ $id.name }}",
          "credentials": [
            {
              "accessKey": "{{ $id.accessKey }}",
              "secretKey": "{{ $id.secretKey }}"
            }
          ],
          "actions": {{ toJson $id.actions }}
        }
        {{- end }}
      ]
    }
