#
# Copyright 2026 The OKDP Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# you may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#

apiVersion: v1alpha1
name: trinodb
#tag: 475-p01
# Currently, the UI requires the version to conform to SemVer (https://simversion.github.io/)
# https://github.com/OKDP/okdp-ui/blob/main/src/app/shared/utils/utils.ts#L131
tag: 475.0.0-p01
protected: false
description: |
  Apache Trino - Distributed SQL query engine designed for large-scale data processing across multiple data sources.
  High-performance, in-memory query engine that enables fast, interactive analytics on diverse data systems.
  Supports querying data from multiple databases, data warehouses, and big data platforms in a single query.
usage:
  text: |
    Apache Trino provides distributed SQL query engine designed for large-scale data processing.
    Access the UI at {{ .Context.trino.endpoint.url | replace "{{ .Release.namespace }}" .Release.spec.targetNamespace | replace "{{ .Release.metadata.name }}" .Release.metadata.name | replace "{{ .Context.ingress.suffix }}" .Context.ingress.suffix }}
schema:
  parameters:
    properties:
      numWorkers: { type: integer, default: 3, description: "Number of workers" }
      workerMemoryGi: { type: number, default: 1, multipleOf: 0.25, description: "Worker memory (GiB) used for Kubernetes requests/limits (recommended: request=limit)." }
      workerCpu: { type: number, default: 0.5, multipleOf: 0.25, description: "Worker CPU request in millicores (e.g., 500=0.5 vCPU, 1000=1 vCPU)." }
  context:
    properties:
      certificateIssuers:
        required: true
        properties:
          selfSigned:
            properties:
              name: { type: string, required: true }
      ingress:
        required: true
        properties:
          suffix: { type: string, required: true }
modules:
  - name: main
    timeout: 10m
    source:
      helmRepository:
        url: https://trinodb.github.io/charts/
        chart: trino
        version: v1.39.1
    values: |
      {{- $trinoEndpoint := .Context.trino.endpoint.url | replace "{{ .Release.namespace }}" .Release.spec.targetNamespace -}}
      {{- $trinoEndpoint := $trinoEndpoint | replace "{{ .Release.metadata.name }}" .Release.metadata.name -}}
      {{- $trinoEndpoint := $trinoEndpoint | replace "{{ .Context.ingress.suffix }}" .Context.ingress.suffix -}}
      {{- $trinoEndpoint := regexReplaceAll "^https?://" $trinoEndpoint "" -}}
      
      {{- $s3ApiUrl := .Context.trino.storage.s3.apiUrl | replace "{{ .Release.namespace }}" .Release.spec.targetNamespace -}}
      {{- $s3ApiUrl := $s3ApiUrl | replace "{{ .Release.metadata.name }}" .Release.metadata.name -}}
      {{- $s3ApiUrl := $s3ApiUrl | replace "{{ .Context.ingress.suffix }}" .Context.ingress.suffix -}}
      
      {{- $hmsUri := .Context.trino.metastore.uri | replace "{{ .Release.namespace }}" .Release.spec.targetNamespace -}}
      
      {{- $keycloakIssuerUri := .Context.trino.auth.oidc.issuerUri | replace "{{ .Release.namespace }}" .Release.spec.targetNamespace -}}
      {{- $keycloakIssuerUri := $keycloakIssuerUri | replace "{{ .Release.metadata.name }}" .Release.metadata.name -}}
      {{- $keycloakIssuerUri := $keycloakIssuerUri | replace "{{ .Context.ingress.suffix }}" .Context.ingress.suffix -}}
      
      image:
        repository: trinodb/trino
        tag: 475
      
      catalogs:
        tpch: |
          connector.name=tpch
          tpch.splits-per-node=4
        tpcds: |
          connector.name=tpcds
          tpcds.splits-per-node=4
        lakehouse: |
          connector.name=hive
          hive.metastore.uri={{ $hmsUri }}
          hive.metastore.username={{ .Context.trino.auth.basic.username }}
          hive.non-managed-table-writes-enabled=true
  
          fs.native-s3.enabled=true
          s3.region=us-east-1
          s3.path-style-access=true
          s3.endpoint={{ $s3ApiUrl }}
          s3.aws-access-key=${ENV:S3_ACCESS_KEY}
          s3.aws-secret-key=${ENV:S3_SECRET_ACCESS}
      envFrom:
        - secretRef:
            name: {{ .Context.trino.storage.s3.credentialsSecret.name }}
      env:
        - name: OAUTH_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: {{ .Context.trino.auth.oidc.credentialsSecret.name }}
              key: {{ .Context.trino.auth.oidc.credentialsSecret.clientIdKey }}
      
        - name: OAUTH_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: {{ .Context.trino.auth.oidc.credentialsSecret.name }}
              key: {{ .Context.trino.auth.oidc.credentialsSecret.clientSecretKey }}

      coordinator:
        resources:
          requests:
            cpu: "500m"
            memory: "1Gi"
          limits:
            cpu: "2"
            memory: "8Gi"
        additionalVolumes:
          - name: generated-files
            emptyDir: {}
          - name: cacerts
            secret:
              secretName: certs-bundle
          - name: trino-tls
            secret:
              secretName: {{ .Release.metadata.name }}-tls
        additionalVolumeMounts:
          - name: generated-files
            mountPath: /etc/trino/generated
            readOnly: false
          - name: cacerts
            mountPath: /cacerts
          - name: trino-tls
            mountPath: /trino-tls
        additionalJVMConfig:
          - "-Djavax.net.ssl.trustStore=/cacerts/bundle.p12"
          - "-Djavax.net.ssl.trustStorePassword="

      worker:
        resources:
          requests:
            cpu: "{{ .Parameters.workerCpu }}"
            memory: "{{ .Parameters.workerMemoryGi }}Gi"
          limits:
            cpu: "{{ mulf (float64 .Parameters.workerCpu) 2 }}"
            memory: "{{ mulf (float64 .Parameters.workerMemoryGi) 2 }}Gi"
        additionalVolumes:
          - name: generated-files
            emptyDir: {}
          - name: cacerts
            secret:
              secretName: certs-bundle
          - name: trino-tls
            secret:
              secretName: {{ .Release.metadata.name }}-tls
        additionalVolumeMounts:
          - name: generated-files
            mountPath: /etc/trino/generated
            readOnly: false
          - name: cacerts
            mountPath: /cacerts
          - name: trino-tls
            mountPath: /trino-tls
        additionalJVMConfig:
          - "-Djavax.net.ssl.trustStore=/cacerts/bundle.p12"
          - "-Djavax.net.ssl.trustStorePassword="

      ingress:
        enabled: true
        className: nginx
        annotations:
          cert-manager.io/cluster-issuer: "{{ .Context.certificateIssuers.selfSigned.name }}"
          nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
          nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
          nginx.ingress.kubernetes.io/use-regex: "true"  
          nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
          nginx.ingress.kubernetes.io/ssl-passthrough: "true"
          nginx.ingress.kubernetes.io/ssl-redirect: "true"
        hosts:
          - host: {{ $trinoEndpoint }}
            paths:
              - path: /
                pathType: Prefix
        tls:
          - hosts:
              - {{ $trinoEndpoint }}
            secretName: {{ .Release.metadata.name }}-tls

      server:
        workers: {{ .Parameters.numWorkers }}
        node:
          environment: sandbox
        config:
          coordinator: "true"
          node-scheduler.include-coordinator: "true"
          discovery-server.enabled: "true"
          path: /etc/trino
          https:
            enabled: true
            port: 8443
            keystore:
              path: "/etc/trino/generated/tls.pem"
        coordinatorExtraConfig: |
          http-server.process-forwarded=true
          web-ui.authentication.type=oauth2
          http-server.authentication.oauth2.issuer={{ $keycloakIssuerUri }}
          http-server.authentication.oauth2.client-id=${ENV:OAUTH_CLIENT_ID}
          http-server.authentication.oauth2.client-secret=${ENV:OAUTH_CLIENT_SECRET}
          http-server.authentication.oauth2.auth-url={{ $keycloakIssuerUri }}/protocol/openid-connect/auth
          http-server.authentication.oauth2.token-url={{ $keycloakIssuerUri }}/protocol/openid-connect/token
          http-server.authentication.oauth2.scopes=openid,email,profile,groups
          deprecated.http-server.authentication.oauth2.groups-field=groups


      initContainers:
        coordinator:
          - name: init-coordinator-coordinator
            image: busybox:1.36
            imagePullPolicy: IfNotPresent
            command: ['sh', '-c', "cat /trino-tls/tls.crt /trino-tls/tls.key > /etc/trino/generated/tls.pem"]
            volumeMounts:
              - name: trino-tls
                mountPath: "/trino-tls"
              - name: generated-files
                readOnly: false
                mountPath: "/etc/trino/generated"
        worker:
          - name: init-coordinator-worker
            image: busybox:1.36
            imagePullPolicy: IfNotPresent
            command: ['sh', '-c', "cat /trino-tls/tls.crt /trino-tls/tls.key > /etc/trino/generated/tls.pem"]
            volumeMounts:
              - name: trino-tls
                mountPath: "/trino-tls"
              - name: generated-files
                readOnly: false
                mountPath: "/etc/trino/generated"

roles:
  - interactive-query
dependencies:
  - data-catalog
  - ingress