apiVersion: v1alpha1
name: spark-history-server
tag: 3.5.1-p03
protected: false
description: |
  Spark History Server - Monitoring and debugging interface for Apache Spark applications.
  Provides detailed execution metrics, job timelines, and performance insights for completed Spark jobs.
  Essential tool for optimizing Spark workloads and troubleshooting data processing pipelines.
usage:
  text: |
    Spark History Server provides a web UI for viewing completed Spark applications.
    {{- if .Parameters.enableWebProxy }}
    {{- $historyEndpointUrl := .Context.sparkHistory.endpoint.url
    | replace "{{ .Release.namespace }}" .Release.spec.targetNamespace
    | replace "{{ .Release.metadata.name }}" .Release.metadata.name
    | replace "{{ .Context.ingress.suffix }}" .Context.ingress.suffix
    -}}
    {{- $historyEndpointScheme := regexFind "^https?://" $historyEndpointUrl | default "https://" -}}
    Access the UI at {{- printf "%s%s-%s.%s" $historyEndpointScheme .Parameters.webProxyUrlPrefix .Release.spec.targetNamespace .Context.ingress.suffix -}}
    {{- else }}
    Access the UI at {{ .Context.sparkHistory.endpoint.url | replace "{{ .Release.namespace }}" .Release.spec.targetNamespace | replace "{{ .Release.metadata.name }}" .Release.metadata.name | replace "{{ .Context.ingress.suffix }}" .Context.ingress.suffix }}
    {{- end }}
schema:
  parameters:
    properties:
      eventsLogDir: { type: string, required: true, default: "s3a://spark-events/event-logs/", description: "S3 path for Spark event logs, typically s3a://<bucket>/eventLogs" }
      adminGroups: { type: string, default: "admins", description: "Comma separated list of admin groups" }
      enableWebProxy: { type: boolean, default: true, description: "Whether to enable Spark History web proxy" }
      webProxyUrlPrefix: { type: string, default: "spark-web-proxy", description: "Spark web proxy url prefix" }
  context:
    properties:
      certificateIssuers:
        required: true
        properties:
          selfSigned:
            properties:
              name: { type: string, required: true }
      ingress:
        required: true
        properties:
          suffix: { type: string, required: true }
modules:
  - name: main
    timeout: 10m
    source:
      oci:
        repository: quay.io/okdp/charts/spark-history-server
        tag: 1.0.0
    values: |
      {{- $s3ApiUrl := .Context.sparkHistory.storage.s3.apiUrl | replace "{{ .Release.namespace }}" .Release.spec.targetNamespace -}}
      {{- $s3ApiUrl := $s3ApiUrl | replace "{{ .Release.metadata.name }}" .Release.metadata.name -}}
      {{- $s3ApiUrl := $s3ApiUrl | replace "{{ .Context.ingress.suffix }}" .Context.ingress.suffix -}}
      
      {{- $historyEndpoint := .Context.sparkHistory.endpoint.url | replace "{{ .Release.namespace }}" .Release.spec.targetNamespace -}}
      {{- $historyEndpoint := $historyEndpoint | replace "{{ .Release.metadata.name }}" .Release.metadata.name -}}
      {{- $historyEndpointUrl := $historyEndpoint | replace "{{ .Context.ingress.suffix }}" .Context.ingress.suffix -}}
      {{- $historyEndpointHost := regexReplaceAll "^https?://" $historyEndpointUrl "" -}}
      
      {{- $keycloakIssuerUri := .Context.sparkHistory.auth.oidc.issuerUri | replace "{{ .Release.namespace }}" .Release.spec.targetNamespace -}}
      {{- $keycloakIssuerUri := $keycloakIssuerUri | replace "{{ .Release.metadata.name }}" .Release.metadata.name -}}
      {{- $keycloakIssuerUri := $keycloakIssuerUri | replace "{{ .Context.ingress.suffix }}" .Context.ingress.suffix -}}
      
      {{- $historyEndpointScheme := regexFind "^https?://" $historyEndpointUrl | default "https://" -}}
      {{- $webProxyEndpointUrl := printf "%s%s-%s.%s" $historyEndpointScheme .Parameters.webProxyUrlPrefix .Release.spec.targetNamespace .Context.ingress.suffix -}}
      
      {{- $historyRedirectUri := $historyEndpointUrl -}}
      
      {{- if .Parameters.enableWebProxy }}
      {{- $historyRedirectUri := $webProxyEndpointUrl -}}
      {{- end }}
      
      image:
        repository: quay.io/okdp/spark
        pullPolicy: IfNotPresent
        tag: "spark-3.5.6-scala-2.12-java-17"
      
      ingress:
        enabled: true
        ingressClassName: "nginx"
        annotations:
          nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
          cert-manager.io/cluster-issuer: {{ .Context.certificateIssuers.selfSigned.name }}
        hosts:
          - host: {{ $historyEndpointHost }}
            paths:
              - path: /
                pathType: Prefix
        tls:
          - hosts:
              - {{ $historyEndpointHost }}
            secretName: {{ .Release.metadata.name }}-tls
      
      config:
        spark.hadoop.fs.s3a.endpoint: {{ $s3ApiUrl }}
        spark.hadoop.fs.s3a.connection.ssl.enabled: true
        spark.history.fs.logDirectory: {{ .Parameters.eventsLogDir }}
        spark.hadoop.fs.s3a.impl: org.apache.hadoop.fs.s3a.S3AFileSystem
        spark.hadoop.fs.s3a.path.style.access: true
        spark.ui.filters: io.okdp.spark.authc.OidcAuthFilter
        spark.user.groups.mapping: io.okdp.spark.authz.OidcGroupMappingServiceProvider
        spark.history.ui.acls.enable: true
        spark.io.okdp.spark.authc.OidcAuthFilter.param.issuer-uri: {{ $keycloakIssuerUri }}
        spark.io.okdp.spark.authc.OidcAuthFilter.param.redirect-uri: {{ $historyRedirectUri }}/home
        spark.io.okdp.spark.authc.OidcAuthFilter.param.scope: {{ .Context.sparkHistory.auth.oidc.scope }}
        spark.io.okdp.spark.authc.OidcAuthFilter.param.cookie-max-age-minutes: 480
        spark.io.okdp.spark.authc.OidcAuthFilter.param.cookie-cipher-secret-key: FC5E81345CED0E256DC42E410362FF6E
        spark.io.okdp.spark.authc.OidcAuthFilter.param.cookie-is-secure: true
        spark.io.okdp.spark.authc.OidcAuthFilter.param.use-pkce: {{ .Context.sparkHistory.auth.oidc.usePKCE }}
        spark.io.okdp.spark.authc.OidcAuthFilter.param.user-id: email # Or sub
        # Members of this group will have access to all jobs.
        spark.history.ui.admin.acls.groups: {{ .Parameters.adminGroups }}
      
      extraEnvs:
        {{- if .Context.sparkHistory.storage.s3.tls.insecureSkipVerify }}
        - name: SPARK_HISTORY_OPTS
          value: -Dcom.amazonaws.sdk.disableCertChecking=true
        {{- end }}
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: {{ .Context.sparkHistory.storage.s3.credentialsSecret.name }}
              key: {{ .Context.sparkHistory.storage.s3.credentialsSecret.accessKeyKey }}
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: {{ .Context.sparkHistory.storage.s3.credentialsSecret.name }}
              key: {{ .Context.sparkHistory.storage.s3.credentialsSecret.secretKeyKey }}
        # Disable Certificate Checking
        - name: SPARK_HISTORY_OPTS
          value: "-Dcom.amazonaws.sdk.disableCertChecking=true"
        - name: JAVA_TOOL_OPTIONS
          value: "-Djavax.net.ssl.trustStore=/cacerts/bundle.p12 -Djavax.net.ssl.trustStorePassword="
        - name: AUTH_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: {{ .Context.sparkHistory.auth.oidc.credentialsSecret.name }}
              key: {{ .Context.sparkHistory.auth.oidc.credentialsSecret.clientIdKey }}
        - name: AUTH_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: {{ .Context.sparkHistory.auth.oidc.credentialsSecret.name }}
              key: {{ .Context.sparkHistory.auth.oidc.credentialsSecret.clientSecretKey }}      
      
      extraVolumes:
        - name: cacerts
          secret:
            secretName: certs-bundle
      
      extraVolumeMounts:
        - name: cacerts
          mountPath: /cacerts
  # TODO: Kubocd â€” Add conditional modules
  - name: proxy
    dependsOn:
      - main
    timeout: 10m
    source:
      oci:
        repository: quay.io/okdp/charts/spark-web-proxy
        tag: 0.1.0
    values: |

      {{- $webProxyEndpointHost := printf "%s-%s.%s" .Parameters.webProxyUrlPrefix .Release.spec.targetNamespace .Context.ingress.suffix -}}
      
      image:
        repository: quay.io/okdp/spark-web-proxy
        pullPolicy: IfNotPresent
        tag: "0.2.1"
      
      configuration:
        spark:
          history:
            service: {{ .Release.metadata.name }}-main.{{ .Release.spec.targetNamespace }}.svc.cluster.local
          ui:
            proxyBase: /sparkui
          jobNamespaces:
            - {{ .Release.spec.targetNamespace }}
      
      ingress:
        enabled: true
        className: "nginx"
        annotations:
          nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
          cert-manager.io/cluster-issuer: {{ .Context.certificateIssuers.selfSigned.name }}
        hosts:
          - host: {{ $webProxyEndpointHost }}
            paths:
              - path: /
                pathType: Prefix
        tls:
          - hosts:
              - {{ $webProxyEndpointHost }}
            secretName: {{ .Release.metadata.name }}-proxy-tls
roles:
  - spark
dependencies:
  - identity
  - storage
  - ingress