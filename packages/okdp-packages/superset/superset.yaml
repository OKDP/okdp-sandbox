apiVersion: v1alpha1
name: superset
tag: 5.0.0-p02
protected: false
description: |
  Apache Superset - Enterprise business intelligence platform for modern data teams.
  Self-service analytics tool that enables users to create interactive dashboards, explore datasets,
  and build data visualizations without coding. Integrates with popular databases and supports SQL Lab.
usage:
  text: |
    Apache Superset provides modern data visualization and exploration capabilities.
    Access the UI at {{ 
     .Context.superset.endpoint.url 
     | replace "{{ .Release.namespace }}" .Release.spec.targetNamespace 
     | replace "{{ .Release.metadata.name }}" .Release.metadata.name 
     | replace "{{ .Context.ingress.suffix }}" .Context.ingress.suffix 
    }}
schema:
  parameters:
    properties:
      adminGroups: { type: string, default: "admins", description: "Admin groups for superset access" }
      load_examples: { type: boolean, default: true, description: "Whether to load superset examples" }
  context:
    properties:
      certificateIssuers:
        required: true
        properties:
          selfSigned:
            properties:
              name: { type: string, required: true }
      ingress:
        required: true
        properties:
          suffix: { type: string, required: true }
modules:
  - name: main
    timeout: 10m
    source:
      oci:
        repository: quay.io/okdp/charts/superset
        tag: 0.15.0-1.1
    values: |
      {{- $supersetUrl := .Context.superset.endpoint.url | replace "{{ .Release.namespace }}" .Release.spec.targetNamespace -}}
      {{- $supersetUrl := $supersetUrl | replace "{{ .Release.metadata.name }}" .Release.metadata.name -}}
      {{- $supersetUrl := $supersetUrl | replace "{{ .Context.ingress.suffix }}" .Context.ingress.suffix -}}
      {{- $supersetHost := regexReplaceAll "^https?://" $supersetUrl "" -}}
      
      okdp:
        # Superset configuration
        superset:
          superset_secret_key: ~
          extra_config: &extra_config |
            from datetime import timedelta
            # Set up max age of session to 8 hours
            PERMANENT_SESSION_LIFETIME = timedelta(hours=8)
            # This will make sure the redirect_uri is properly computed, even with SSL offloading
            ENABLE_PROXY_FIX = True
          feature_flags: &feature_flags |
            # https://github.com/apache/superset/blob/master/RESOURCES/FEATURE_FLAGS.md
            FEATURE_FLAGS = {
              "DASHBOARD_RBAC": True,
              "EMBEDDED_SUPERSET": True,
              "EMBEDDABLE_CHARTS": True,
              "ENABLE_TEMPLATE_PROCESSING": True,
              "DASHBOARD_NATIVE_FILTERS": True,
              "DASHBOARD_CROSS_FILTERS": True,
            }
          load_examples:
            enabled: {{ .Parameters.load_examples }}
            jdbc_uri: {{ .Context.superset.load_examples.jdbc_uri }}

        # Oauth2 configuration
        oauth:
          enabled: {{ .Context.superset.auth.enabled }}
          provider: "{{ .Context.superset.auth.oidc.provider }}"
          base_url: {{ .Context.superset.auth.oidc.baseUrl | replace "{{ .Context.ingress.suffix }}" .Context.ingress.suffix }}
          scope: "{{ .Context.superset.auth.oidc.scope }}"
          use_pkce: {{ .Context.superset.auth.oidc.usePKCE }}
          ssl_certificate_verify: "{{ ternary "False" "True" .Context.superset.auth.oidc.insecureSkipVerify }}"
          auth_registration: &auth_registration |
            AUTH_USER_REGISTRATION = True
            AUTH_ROLE_PUBLIC = "Public"
            AUTH_USER_REGISTRATION_ROLE = "Public"
            AUTH_ROLES_SYNC_AT_LOGIN = True
          oauth2_superset_roles_mapping: &oauth2_superset_roles_mapping |
            AUTH_ROLES_MAPPING = {
              "{{ .Parameters.adminGroups }}": ["Admin"]
            }      
      superset:
        extraConfigs:
          import_datasources.yaml: |
      {{ .Context.superset.dataSources
         | replace "{{ .Release.namespace }}" .Release.spec.targetNamespace
         | replace "{{ .Context.ingress.suffix }}" .Context.ingress.suffix
         | indent 6 }}
        postgresql:
          # Use an external database
          enabled: false
        # If no existing redis cache provided, enable to use the bitnami redis cache
        # The credentials should match 'superset.supersetNode.connections'
        redis:
          enabled: true
          architecture: standalone
          auth:
            ## Enable password authentication
            enabled: false
        extraEnvRaw:
          # Superset secret key
          - name: SUPERSET_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: {{ .Context.superset.secret.name }}
                key: {{ .Context.superset.secret.key }}
          # Superset/DB credentials
          - name: DB_USER
            valueFrom:
              secretKeyRef:
                name: {{ .Context.superset.database.credentialsSecret.name }}
                key: {{ .Context.superset.database.credentialsSecret.usernameKey }}
          - name: DB_PASS
            valueFrom:
              secretKeyRef:
                name: {{ .Context.superset.database.credentialsSecret.name }}
                key: {{ .Context.superset.database.credentialsSecret.passwordKey }}
          # Superset/Redis credentials
          - name: REDIS_USER
            valueFrom:
              secretKeyRef:
                name: {{ .Context.superset.redis.credentialsSecret.name }}
                key: {{ .Context.superset.redis.credentialsSecret.usernameKey }}
          - name: REDIS_PASSWORD
            valueFrom:
              secretKeyRef:
                name: {{ .Context.superset.redis.credentialsSecret.name }}
                key: {{ .Context.superset.redis.credentialsSecret.passwordKey }}
          # OIDC credentials
          - name: AUTH_OAUTH_CLIENT_ID
            valueFrom:
              secretKeyRef:
                name: {{ .Context.superset.auth.oidc.credentialsSecret.name }}
                key: {{ .Context.superset.auth.oidc.credentialsSecret.clientIdKey }}
          - name: AUTH_OAUTH_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: {{ .Context.superset.auth.oidc.credentialsSecret.name }}
                key: {{ .Context.superset.auth.oidc.credentialsSecret.clientSecretKey }}
          # Examples
          {{- if .Parameters.load_examples }}
          - name: DB_EXAMPLES_HOST
            value: {{ .Context.superset.load_examples.database.host }}
          - name: DB_EXAMPLES_PORT
            value: "{{ .Context.superset.load_examples.database.port }}"
          - name: DB_EXAMPLES_NAME
            value: {{ .Context.superset.load_examples.database.name }}
          - name: DB_EXAMPLES_USER
            valueFrom:
              secretKeyRef:
                name: {{ .Context.superset.load_examples.database.credentialsSecret.name }}
                key: {{ .Context.superset.load_examples.database.credentialsSecret.usernameKey }}         
          - name: DB_EXAMPLES_PASS
            valueFrom:
              secretKeyRef:
                name: {{ .Context.superset.load_examples.database.credentialsSecret.name }}
                key: {{ .Context.superset.load_examples.database.credentialsSecret.passwordKey }}            
          {{- end }}
        supersetNode:
          # Connections to an existing database and cache
          connections:
            # -- PostgreSQL
            db_host: "{{ .Context.superset.database.host }}"
            db_port: "{{ .Context.superset.database.port }}"
            db_name: {{ .Context.superset.database.name }}
            db_user: ~
            db_pass: ~
            # -- Redis
            redis_host: {{ default (printf "%s-main-redis-headless" .Release.metadata.name) .Context.superset.redis.host | quote }}
            redis_port: {{ .Context.superset.redis.port }}
            redis_user: ~
            redis_password: ~
            redis_cache_db: "1"
            redis_celery_db: "0"
            redis_ssl:
              enabled: false
              ssl_cert_reqs: CERT_NONE
            
        ingress:
          enabled: true
          ingressClassName: "nginx"
          annotations:
            kubernetes.io/ingress.class: nginx
            cert-manager.io/cluster-issuer: {{ .Context.certificateIssuers.selfSigned.name }}
            acme.cert-manager.io/http01-edit-in-place: "true"
            # kubernetes.io/tls-acme: "true"
            ## Extend timeout to allow long running queries.
            nginx.ingress.kubernetes.io/proxy-connect-timeout: "300"
            nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
            nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
            nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
          path: /
          pathType: ImplementationSpecific
          hosts:
            - {{ $supersetHost }}
          tls:
            - hosts:
                - {{ $supersetHost }}
              secretName: "{{ .Release.metadata.name }}-tls-secret"
      
        configOverrides:
          auth_registration: *auth_registration
          oauth_to_superset_roles_mapping: *oauth2_superset_roles_mapping
          extra_config: *extra_config
          feature_flags: *feature_flags

roles:
  - dataviz
dependencies:
  - database-server
  - ingress 